function _construct(e,t,n){if(_isNativeReflectConstruct())return Reflect.construct.apply(null,arguments);var r=[null];r.push.apply(r,t);var i=new(e.bind.apply(e,r));return n&&_setPrototypeOf(i,n.prototype),i}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}function _isNativeReflectConstruct(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(_isNativeReflectConstruct=function(){return!!e})()}var isEmptyStr=function(e){return""===e},isEmptyObj=function(e){if(e===undefined)return!1;if(null===e)return!0;for(var t in e)return!1;return!0},isInteger=function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e};Array.prototype.removeEmpty||(Array.prototype.removeEmpty=function(){for(var e=[],t=0,n=this.length;t<n;t++){var r=this[t];null!=r&&""!==r&&(r instanceof Array&&0===r.length||r instanceof Object&&isEmptyObj(r)||e.push(r))}return e}),function(){if("object"!=typeof JSON){JSON={};var e,t,n,r,i=/^[\],:{}\s]*$/,o=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,u=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,a=/(?:^|:|,)(?:\s*\[)+/g,l=/[\\"\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,c=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":"Invalid Date"}),"function"!=typeof JSON.stringify&&(n={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},JSON.stringify=function(n,i,o){var u;if(e="",t="","number"==typeof o)for(u=0;u<o;u+=1)t+=" ";else"string"==typeof o&&(t=o);if(r=i,i&&"function"!=typeof i&&("object"!=typeof i||"number"!=typeof i.length))throw new Error("JSON.stringify");return str("",{"":n})}),"function"!=typeof JSON.parse&&(JSON.parse=function(e,t){var n;function walk(e,n){var r,i,o=e[n];if(o&&"object"==typeof o)for(r in o)Object.prototype.hasOwnProperty.call(o,r)&&((i=walk(o,r))!==undefined?o[r]=i:delete o[r]);return t.call(e,n,o)}if(e=String(e),c.lastIndex=0,c.test(e)&&(e=e.replace(c,(function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}))),i.test(e.replace(o,"@").replace(u,"]").replace(a,"")))return n=Function("return ("+e+")")(),"function"==typeof t?walk({"":n},""):n;throw new Error("JSON.parse")})}function f(e){return e<10?"0"+e:e}function quote(e){return l.lastIndex=0,l.test(e)?'"'+e.replace(l,(function(e){var t=n[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}))+'"':'"'+e+'"'}function str(n,i){var o,u,a,l,c,s=e,p=i[n];switch(p&&"object"==typeof p&&"function"==typeof p.toJSON&&(p=p.toJSON(n)),"function"==typeof r&&(p=r.call(i,n,p)),typeof p){case"string":return quote(p);case"number":return isFinite(p)?String(p):"null";case"boolean":return String(p);case"object":if(!p)return"null";if(e+=t,c=[],"[object Array]"===Object.prototype.toString.apply(p)){for(l=p.length,o=0;o<l;o+=1)c[o]=str(String(o),p)||"null";return a=0===c.length?"[]":e?"[\n"+e+c.join(",\n"+e)+"\n"+s+"]":"["+c.join(",")+"]",e=s,a}if(r&&"object"==typeof r)for(l=r.length,o=0;o<l;o+=1)"string"==typeof r[o]&&(a=str(u=String(r[o]),p))&&c.push(quote(u)+(e?": ":":")+a);else for(u in p)Object.prototype.hasOwnProperty.call(p,u)&&(a=str(u,p))&&c.push(quote(u)+(e?": ":":")+a);return a=0===c.length?"{}":e?"{\n"+e+c.join(",\n"+e)+"\n"+s+"}":"{"+c.join(",")+"}",e=s,a}return"null"}}();var dateToBit=function(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];if(1===n.length)e=n[0];else{var i=n[0],o=n[1],u=n.slice(2);e=_construct(Date,[i,o-1].concat(u)).getTime()}var a=(.001*e+11644473600)/1e-7/Math.pow(2,32),l=Math.floor(a);return{high:l,low:(a-l)*Math.pow(2,32)}},getFiletime=function(e){var t,n=[],r=null!=(t=e.split(","))?t:[0];if(~e.indexOf("."))return e;for(var i=0;i<r.length;i++){var o=r[i];n.push(Number(o))}var u=dateToBit.apply(void 0,n);return u.high+"."+u.low},_rangeProp=function(e,t,n,r){return isInteger(t)&&n<=t&&t<=r?","+e+":"+t:""},buildLfItem=function(e){var t=e.name,n=e.sname,r=void 0===n?"":n,i=e.att,o=void 0===i?0:i,u=e.date,a=e.ext,l=e.hl,c=e.mark,s=e.comment;if(t&&!isEmptyStr(t)){u||(u=(new Date).toLocaleString().replace(/\D+/g,",")),isNaN(o)&&(o=0);var p=getFiletime(u);return'"'+t+'","'+r+'",A:H'+o+",C:"+p+",L:"+p+",W:"+p+",S:0.0"+(isInteger(a)?",X:"+a:"")+_rangeProp("H",l,1,7)+_rangeProp("M",c,-1,1)+(s?',T:"'+s.replace(/"/g,'""')+'"':"")}},validArgs=function(){for(var e=[],t=PPx.Arguments;!t.atEnd();t.moveNext())e.push(t.value);return e},safeArgs=function(){for(var e=[],t=validArgs(),n=0,r=arguments.length;n<r;n++)e.push(_valueConverter(n<0||arguments.length<=n?undefined:arguments[n],t[n]));return e},_valueConverter=function(e,t){if(null==t||""===t)return null!=e?e:undefined;switch(typeof e){case"number":var n=Number(t);return isNaN(n)?e:n;case"boolean":return"false"!==t&&"0"!==t&&null!=t;default:return t}},e={ppmName:"ppx-plugin-manager",ppmVersion:.95,language:"ja",encode:"utf16le",nlcode:"\r\n",nltype:"crlf",ppmID:"P",ppmSubID:"Q"},useLanguage=function(){var t=PPx.Extract("%*getcust(S_ppm#global:lang)");return"en"===t||"ja"===t?t:e.language},t=PPx.CreateObject("Scripting.FileSystemObject"),expandNlCode=function(e){var t="\n",n=e.indexOf("\r");return~n&&(t="\r\n"==e.substring(n,n+2)?"\r\n":"\r"),t},isCV8=function(){return"ClearScriptV8"===PPx.ScriptEngineName},n={TypeToCode:{crlf:"\r\n",cr:"\r",lf:"\n"},CodeToType:{"\r\n":"crlf","\r":"cr","\n":"lf"},Ppx:{lf:"%%bl",cr:"%%br",crlf:"%%bn",unix:"%%bl",mac:"%%br",dos:"%%bn","\n":"%%bl","\r":"%%br","\r\n":"%%bn"},Ascii:{lf:"10",cr:"13",crlf:"-1",unix:"10",mac:"13",dos:"-1","\n":"10","\r":"13","\r\n":"-1"}},exec=function(e,t){try{var n;return[!1,null!=(n=t())?n:""]}catch(r){return[!0,""]}finally{e.Close()}},read=function(e){var n=e.path,r=e.enc,i=void 0===r?"utf8":r;if(!t.FileExists(n))return[!0,n+" not found"];var o=t.GetFile(n);if(0===o.Size)return[!0,n+" has no data"];var u=!1,a="";if("utf8"===i){var l=PPx.CreateObject("ADODB.Stream"),c=exec(l,(function(){return l.Open(),l.Charset="UTF-8",l.LoadFromFile(n),l.ReadText(-1)}));u=c[0],a=c[1]}else{var s="utf16le"===i?-1:0,p=o.OpenAsTextStream(1,s),d=exec(p,(function(){return p.ReadAll()}));u=d[0],a=d[1]}return u?[!0,"Unable to read "+n]:[!1,a]},readLines=function(e){var t,n=e.path,r=e.enc,i=void 0===r?"utf8":r,o=e.linefeed,u=read({path:n,enc:i}),a=u[0],l=u[1];if(a)return[!0,l];o=null!=(t=o)?t:expandNlCode(l.slice(0,1e3));var c=l.split(o);return isEmptyStr(c[c.length-1])&&c.pop(),[!1,{lines:c,nl:o}]},writeLines=function(r){var i=r.path,o=r.data,u=r.enc,a=void 0===u?"utf8":u,l=r.append,c=void 0!==l&&l,s=r.overwrite,p=void 0!==s&&s,d=r.linefeed,v=void 0===d?e.nlcode:d;if(!p&&!c&&t.FileExists(i))return[!0,i+" already exists"];var g,y=t.GetParentFolderName(i);if(t.FolderExists(y)||PPx.Execute("*makedir "+y),"utf8"===a){if(isCV8()){var h=o.join(v),b=c?"AppendAllText":"WriteAllText";return[!1,NETAPI.System.IO.File[b](i,h)]}var P=p||c?2:1,m=PPx.CreateObject("ADODB.Stream");g=exec(m,(function(){m.Open(),m.Charset="UTF-8",m.LineSeparator=Number(n.Ascii[v]),c?(m.LoadFromFile(i),m.Position=m.Size,m.SetEOS):m.Position=0,m.WriteText(o.join(v),1),m.SaveToFile(i,P)}))[0]}else{var x=c?8:p?2:1;t.FileExists(i)||PPx.Execute("%Osq *makefile "+i);var O="utf16le"===a?-1:0,S=t.GetFile(i).OpenAsTextStream(x,O);g=exec(S,(function(){S.Write(o.join(v)+v)}))[0]}return g?[!0,"Could not write to "+i]:[!1,""]},fileEnc=function(t){return"utf8"===t||"sjis"===t?t:e.encode},_dotEntries=function(){var e=PPx.Extract("%*getcust(XC_tdir)").split(","),t=e[0],n=e[1];return Number(t)+Number(n)},getIndex=function(e){for(var t=0;e.length>t&&0===e[t].indexOf(";");)t++;return PPx.Entry.Index+_dotEntries()+t},r={en:{notListFile:"Not a ListFile",subTitle:"Head [n:] is att. n: 1=R 2=H 4=S 8=L 10=D"},ja:{notListFile:"リストファイルではありません",subTitle:"行頭[n:]は属性値 n: 1=R 2=H 4=S 8=L 10=D"}}[useLanguage()],main=function(){var t=safeArgs(undefined,e.encode),n=t[0],i=t[1],o=PPx.DirectoryType,u=4===o?PPx.Extract("%FDV").replace("::listfile",""):n;u||(PPx.linemessage('!"'+r.notListFile),PPx.Quit(-1));var a=noteEntry(),l=a[0],c=a[1];if(!isEmptyStr(c)){var s=buildLfItem({name:c,att:l});if(s){var p,d,v=fileEnc(i);if(4===o){var g=readLines({path:u,enc:v,linefeed:e.nlcode}),y=g[0],h=g[1];y&&(PPx.linemessage('!"'+h),PPx.Quit(-1)),h.lines.splice(getIndex(h.lines),0,s);var b=writeLines({path:u,data:h.lines,enc:v,overwrite:!0,linefeed:h.nl});p=b[0],d=b[1]}else{var P=writeLines({path:u,data:[s],enc:v,append:!0,linefeed:e.nlcode});p=P[0],d=P[1]}p&&(PPx.linemessage('!"'+d),PPx.Quit(-1)),4===o&&(PPx.Execute("*wait 100,1%:*jumppath -savelocate"),PPx.Entry.State=4)}}},noteEntry=function(){var e="'title':'Note  "+r.subTitle+"','mode':'e','leavecancel':true,'list':'off','module':'off'",t=PPx.Extract('%*script("%sgu\'ppmlib\'\\input.js","{'+e+'}")');if("[error]"===t||isEmptyStr(t))return[0,""];var n="#=8=#",i=t.replace(/^((\d+):\s*)?(.+)$/,"$2"+n+"$3").split(n),o=i[0],u=i[1];return[Number(o),u.replace(/"/g,"`")]};main();
