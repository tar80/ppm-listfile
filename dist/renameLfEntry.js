var validArgs=function(){for(var e=[],r=PPx.Arguments;!r.atEnd();r.moveNext())e.push(r.value);return e},safeArgs=function(){for(var e=[],r=validArgs(),n=0,t=arguments.length;n<t;n++)e.push(_valueConverter(n<0||arguments.length<=n?undefined:arguments[n],r[n]));return e},_valueConverter=function(e,r){if(null==r||""===r)return null!=e?e:undefined;switch(typeof e){case"number":var n=Number(r);return isNaN(n)?e:n;case"boolean":return"false"!==r&&"0"!==r&&null!=r;default:return r}},e={ppmName:"ppx-plugin-manager",ppmVersion:.95,language:"ja",encode:"utf16le",nlcode:"\r\n",nltype:"crlf",ppmID:"P",ppmSubID:"Q"},useLanguage=function(){var r=PPx.Extract("%*getcust(S_ppm#global:lang)");return"en"===r||"ja"===r?r:e.language},r=PPx.CreateObject("Scripting.FileSystemObject"),isEmptyStr=function(e){return""===e},isZero=function(e){return"string"==typeof e?"0"===e:0===e},expandNlCode=function(e){var r="\n",n=e.indexOf("\r");return~n&&(r="\r\n"==e.substring(n,n+2)?"\r\n":"\r"),r},isCV8=function(){return"ClearScriptV8"===PPx.ScriptEngineName},n={TypeToCode:{crlf:"\r\n",cr:"\r",lf:"\n"},CodeToType:{"\r\n":"crlf","\r":"cr","\n":"lf"},Ppx:{lf:"%%bl",cr:"%%br",crlf:"%%bn",unix:"%%bl",mac:"%%br",dos:"%%bn","\n":"%%bl","\r":"%%br","\r\n":"%%bn"},Ascii:{lf:"10",cr:"13",crlf:"-1",unix:"10",mac:"13",dos:"-1","\n":"10","\r":"13","\r\n":"-1"}},exec=function(e,r){try{var n;return[!1,null!=(n=r())?n:""]}catch(t){return[!0,""]}finally{e.Close()}},read=function(e){var n=e.path,t=e.enc,i=void 0===t?"utf8":t;if(!r.FileExists(n))return[!0,n+" not found"];var a=r.GetFile(n);if(0===a.Size)return[!0,n+" has no data"];var l=!1,u="";if("utf8"===i){var o=PPx.CreateObject("ADODB.Stream"),c=exec(o,(function(){return o.Open(),o.Charset="UTF-8",o.LoadFromFile(n),o.ReadText(-1)}));l=c[0],u=c[1]}else{var f="utf16le"===i?-1:0,s=a.OpenAsTextStream(1,f),d=exec(s,(function(){return s.ReadAll()}));l=d[0],u=d[1]}return l?[!0,"Unable to read "+n]:[!1,u]},readLines=function(e){var r,n=e.path,t=e.enc,i=void 0===t?"utf8":t,a=e.linefeed,l=read({path:n,enc:i}),u=l[0],o=l[1];if(u)return[!0,o];a=null!=(r=a)?r:expandNlCode(o.slice(0,1e3));var c=o.split(a);return isEmptyStr(c[c.length-1])&&c.pop(),[!1,{lines:c,nl:a}]},writeLines=function(t){var i=t.path,a=t.data,l=t.enc,u=void 0===l?"utf8":l,o=t.append,c=void 0!==o&&o,f=t.overwrite,s=void 0!==f&&f,d=t.linefeed,p=void 0===d?e.nlcode:d;if(!s&&!c&&r.FileExists(i))return[!0,i+" already exists"];var x,P=r.GetParentFolderName(i);if(r.FolderExists(P)||PPx.Execute("*makedir "+P),"utf8"===u){if(isCV8()){var m=a.join(p),v=c?"AppendAllText":"WriteAllText";return[!1,NETAPI.System.IO.File[v](i,m)]}var g=s||c?2:1,E=PPx.CreateObject("ADODB.Stream");x=exec(E,(function(){E.Open(),E.Charset="UTF-8",E.LineSeparator=Number(n.Ascii[p]),c?(E.LoadFromFile(i),E.Position=E.Size,E.SetEOS):E.Position=0,E.WriteText(a.join(p),1),E.SaveToFile(i,g)}))[0]}else{var b=c?8:s?2:1;r.FileExists(i)||PPx.Execute("%Osq *makefile "+i);var F="utf16le"===u?-1:0,h=r.GetFile(i).OpenAsTextStream(b,F);x=exec(h,(function(){h.Write(a.join(p)+p)}))[0]}return x?[!0,"Could not write to "+i]:[!1,""]},fileEnc=function(r){return"utf8"===r||"sjis"===r?r:e.encode},t={en:{failedRewrite:"Failed to rewrite",couldNotRead:"Could not read ListFile",rename:"Undoable rename"},ja:{failedRewrite:"書き換えに失敗しました",couldNotRead:"リストファイルを読み込めませんでした",rename:"名前変更(Undo有効)"}}[useLanguage()],main=function(){var n=safeArgs(!1,e.encode),i=n[0],a=n[1],l=PPx.DirectoryType;if(PPx.EntryState<2&&PPx.Quit(-1),4!==l)return l;var u=PPx.Extract("%FDCN"),o=fileEnc(a);if(r.FileExists(u)||r.FolderExists(u))return doRename(i),4;var c=PPx.Extract('%*input("%C" -title:"Rename" -mode:Ec -k *cursor -8%%:*mapkey use,K_ppmRename)'),f=PPx.Extract();if(!isZero(f)||isEmptyStr(c))return 4;var s=PPx.Extract("%FDV"),d=readLines({path:s,enc:o,linefeed:e.nlcode}),p=d[0],x=d[1];p&&(PPx.linemessage('!"'+t.couldNotRead),PPx.Quit(-1));for(var P=PPx.Extract("%R"),m=/^"[^"]+",(.+)$/,v=0,g=x.lines.length;v<g;v++){var E=x.lines[v];1===E.indexOf(P)&&(x.lines[v]=E.replace(m,'"'+c+'",$1'))}var b=writeLines({path:s,data:x.lines,enc:o,overwrite:!0,linefeed:x.nl}),F=b[0],h=b[1];return F&&(PPx.linemessage('!"'+h),PPx.Quit(-1)),PPx.Execute('*wait 100,1%:*jumppath -entry:"'+c+'"'),4},doRename=function(e){var r=e?'*ppcfile !rename -min -same:skip -error:dialog -undolog:on -log:off -name:"%*input("%C" -title:"'+t.rename+'" -mode:Ec -k *cursor -8%%:*mapkey use,K_ppmRename)"':'%K"@R"';PPx.Execute(r)};PPx.result=main();
